# Общая информация о проекте ZVK Requests

Этот документ содержит высокоуровневое описание архитектуры, стека технологий, процесса развертывания и ключевых аспектов проекта "ZVK Requests", предназначенное для быстрого ознакомления и использования в качестве контекста для ИИ.

## 1. Обзор проекта

**ZVK Requests** — это веб-приложение для управления бизнес-запросами и регистрацией сделок. Оно обеспечивает взаимодействие между пользователями (создающими запросы) и менеджерами (обрабатывающими их).

**Основные функции:**
- Аутентификация и авторизация пользователей (с ролями "USER" и "MANAGER").
- Форма регистрации сделок с валидацией в реальном времени.
- Панель управления для менеджеров для управления запросами.
- Поддержка вложений файлов.
- Поиск клиентов по ИНН.

## 2. Архитектура

Проект представляет собой полнофункциональное (full-stack) приложение, состоящее из двух основных частей:
- **Фронтенд (Frontend)**: Клиентское приложение, работающее в браузере.
- **Бэкенд (Backend)**: Серверное приложение, предоставляющее API для фронтенда и взаимодействующее с базой данных.

Взаимодействие между фронтендом и бэкендом происходит через HTTP/HTTPS запросы к API бэкенда.

## 3. Стек технологий

### 3.1. Фронтенд (клиент)
- **Фреймворк**: [Next.js](https://nextjs.org/) (с `app` роутером).
- **Язык**: TypeScript.
- **Управление состоянием и данными**:
    - [React Query](https://tanstack.com/query/latest) для асинхронной выборки, кэширования и синхронизации данных.
    - `AuthContext` (React Context API) для управления состоянием аутентификации на стороне клиента, включая кэширование в `localStorage` с TTL и кросс-вкладочную синхронизацию.
- **Стилизация**: [TailwindCSS](https://tailwindcss.com/).
- **Обработка форм**: [React Hook Form](https://react-hook-form.com/).
- **Middleware**: Используется `next/middleware.ts` для базовой обработки запросов, но **не для аутентификации/редиректа**, так как JWT-кука недоступна в контексте мидлваря из-за кросс-доменной политики. Аутентификация и защита маршрутов полностью реализуются на стороне клиента с помощью `ProtectedRoute` и `AuthContext`.

### 3.2. Бэкенд (сервер)
- **Язык**: [Go](https://go.dev/).
- **HTTP сервер**: Используется стандартная библиотека Go (`net/http`) и [Gorilla Mux](https://github.com/gorilla/mux) для маршрутизации.
- **База данных**: [PostgreSQL](https://www.postgresql.org/).
- **Аутентификация**:
    - [JWT (JSON Web Tokens)](https://jwt.io/) для токенов сессии.
    - Токены передаются через HttpOnly куки с атрибутом `SameSite=None` и `Secure=true` для кросс-доменного взаимодействия (Vercel/API-сервер).
- **Миграции базы данных**: Используется `github.com/golang-migrate/migrate/v4`.
- **Конфигурация**: Переменные окружения загружаются из `.env` файлов с использованием `github.com/joho/godotenv`.
- **CORS**: Обрабатывается на уровне Nginx и частично на бэкенде.

## 3.3. База данных
- **Тип**: PostgreSQL 15+.
- **Имя**: `zvk_requests`.
- **Пользователь**: `postgres` (с конфигурируемым паролем).
- **Миграции**: Управляются Go-приложением при запуске.

## 4. Развертывание и инфраструктура

- **Фронтенд**: Развернут на [Vercel](https://vercel.com/).
- **Бэкенд**: Развернут на удаленном сервере (`178.208.92.34`) с использованием Docker и Docker Compose.
- **DNS**: `api.zvk-requests.ru` указывает на IP-адрес сервера с бэкендом.
- **Веб-сервер/Реверс-прокси**: [Nginx](https://nginx.org/) в Docker-контейнере.
    - Nginx проксирует запросы на `/api/` к Go бэкенду.
    - Настроена поддержка SSL/HTTPS (используются сертификаты Let's Encrypt).
    - Nginx обрабатывает CORS `OPTIONS` запросы и добавляет необходимые `Access-Control-Allow-Origin`, `Access-Control-Allow-Credentials` заголовки для обычных запросов.

## 5. Процесс CI/CD (GitHub Actions)

Проект использует GitHub Actions для автоматизации CI/CD пайплайна:
- **Сборка и тестирование фронтенда**:
    - Установка зависимостей (`npm install`).
    - Линтинг (`npm run lint`).
    - Сборка Next.js приложения (`npm run build`).
- **Сборка и тестирование бэкенда**:
    - Установка Go зависимостей (`go mod download`).
    - Сборка Go приложения.
- **Развертывание на сервер**:
    - Выполняется по `push` в `main` ветку.
    - Подключается по SSH к удаленному серверу.
    - Загружает последние изменения из репозитория.
    - Генерирует и записывает `.env` файлы для бэкенда из GitHub Secrets.
    - Выполняет `docker compose up -d --build` для обновления Docker контейнеров (Go бэкенд, PostgreSQL, Nginx).

## 6. Ключевые файлы и директории

- `client/`: Директория фронтенд-приложения (Next.js).
    - `client/src/context/AuthContext.tsx`: Реализация контекста аутентификации с кэшированием и синхронизацией.
    - `client/src/components/ProtectedRoute.tsx`: Компонент для защиты маршрутов на стороне клиента.
    - `client/src/middleware.ts`: Next.js middleware (не используется для аутентификации).
    - `client/src/app/(auth)/register/page.tsx`: Страница регистрации.
    - `client/package.json`: Зависимости и скрипты фронтенда.
- `server/`: Директория бэкенд-приложения (Go).
    - `server/main.go`: Основной файл Go-приложения, точки входа API.
    - `server/handlers/auth.go`: Хендлеры аутентификации (регистрация, логин, логаут, `me`, `refresh`).
    - `server/Dockerfile`: Dockerfile для сборки образа Go бэкенда.
    - `server/.env`: Файл переменных окружения для бэкенда.
    - `server/db/migrations/`: Директория с SQL-миграциями базы данных.
    - `server/go.mod`, `server/go.sum`: Файлы Go модулей.
- `nginx/`: Директория с конфигурацией Nginx.
    - `nginx/conf.d/default.conf`: Основной конфигурационный файл Nginx.
    - `nginx/ssl/`: Директория для SSL-сертификатов.
- `.github/workflows/ci-cd.yml`: Файл GitHub Actions для CI/CD пайплайна.
- `docker-compose.secure.yml`: Docker Compose файл для продакшен-развертывания (Go, PostgreSQL, Nginx).
- `API_DOCS.md`: Документация по API.
- `README.md`: Общее описание проекта и инструкции по локальному запуску.

## 7. Распространенные проблемы и решения (История отладки)

В процессе разработки и развертывания были решены следующие ключевые проблемы:

1.  **Проблемы с переменными окружения**:
    - **Ошибка**: Бэкенд не мог подключиться к БД из-за отсутствия `DB_PASSWORD`.
    - **Решение**: Обеспечена корректная передача всех необходимых переменных окружения через `.env` файлы на сервере, в т.ч. через GitHub Secrets в CI/CD.
2.  **Занятый порт 80/443 на сервере**:
    - **Ошибка**: Nginx в Docker не мог запуститься, так как порт 80 уже был занят системным Nginx.
    - **Решение**: Остановка и отключение системного Nginx (`sudo systemctl stop nginx`, `sudo systemctl disable nginx`).
3.  **Отсутствие SSL-сертификатов для Nginx**:
    - **Ошибка**: Nginx не мог загрузить сертификаты.
    - **Решение**: Временные самоподписанные сертификаты, а затем полноценные Let's Encrypt с автообновлением.
4.  **Ошибка аутентификации PostgreSQL**:
    - **Ошибка**: `FATAL: password authentication failed for user "postgres"`. Проблема с устаревшими данными тома Docker.
    - **Решение**: Полная очистка Docker-томов и `docker system prune -a --volumes` для чистого старта БД.
5.  **Недоступность `/api/health`**:
    - **Ошибка**: Nginx возвращал 404 для `/health`, так как маршрут был только `/api/`.
    - **Решение**: Изменен маршрут `/health` в Go бэкенде на `/api/health`.
6.  **Отсутствие `password_confirmation` при регистрации**:
    - **Ошибка**: Фронтенд не отправлял поле `password_confirmation` при регистрации.
    - **Решение**: Добавлено поле `password_confirmation` в запросе регистрации на фронтенде и обновлена документация API.
7.  **Проблемы с CI/CD (GitHub Actions)**:
    - **Ошибки**: Некорректный синтаксис YAML, проблемы с кэшированием Go-модулей, отсутствие скрипта `test` на фронтенде.
    - **Решение**: Коррекция YAML, добавление `cache-dependency-path: server/go.sum`, добавление `test` скрипта в `package.json` фронтенда.
8.  **Проблемы с кросс-доменной аутентификацией (CORS и HttpOnly cookies)**:
    - **Симптомы**: Бесконечные редиректы после логина, ошибки UI несмотря на успешный логин, 401 для `/api/me`.
    - **Причина**: Кука с JWT была установлена с `SameSite=Lax`, что мешало её отправке с Vercel фронтенда на домен API. Также Nginx не добавлял нужные CORS заголовки для обычных запросов.
    - **Решение**:
        - В `server/handlers/auth.go`: Изменен `SameSite` на `SameSiteNoneMode` для JWT-куки (как при установке, так и при удалении).
        - В `nginx/conf.d/default.conf`: Добавлены заголовки `Access-Control-Allow-Origin` и `Access-Control-Allow-Credentials` для обычных (не OPTIONS) ответов.
9.  **Бесконечный цикл редиректа на фронтенде**:
    - **Причина**: `client/src/middleware.ts` пытался обрабатывать аутентификацию, но не мог получить доступ к HttpOnly куке с другого домена, что приводило к конфликту с логикой `ProtectedRoute`.
    - **Решение**: Удалена вся логика аутентификации/редиректа из `client/src/middleware.ts`, оставив ее полностью на клиентской стороне (`AuthContext`, `ProtectedRoute`).
10. **Чрезмерные запросы `/api/me` (rate limiting)**:
    - **Причина**: Множественные компоненты вызывали `checkAuth` при монтировании/изменении маршрута.
    - **Решение**: Удалены избыточные вызовы `checkAuth(true)` из `client/src/components/ProtectedRoute.tsx`.
    - В `AuthContext.tsx` реализовано кэширование результатов `checkAuth` в `localStorage` с TTL, троттлинг параллельных запросов и экспоненциальный бэкофф при сетевых ошибках.
11. **Некорректная работа кнопки "Зарегистрировать сделку" и выхода**:
    - **Причина**: Проблемы с валидацией/обработкой форм на фронтенде, а также неправильное удаление куки при выходе.
    - **Решение**: `SameSite=None` для куки выхода в Go бэкенде, удаление избыточных редиректов в `Header.tsx` (логика навигации делегирована `AuthContext`).
